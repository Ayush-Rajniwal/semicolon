<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Testing Traptcha</title>

    <link rel="stylesheet" type="text/css" href="/css/style.css" />

    <!-- jquery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    <!-- p5js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.10.2/p5.js"></script>

    <!-- socket io (Part of client code)-->
    <script src="/socket.io/socket.io.js"></script>

    <!-- jQuery Modal -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.css"
    />
  </head>
  <body>
    <div class="login-page">
      <div class="form">
        <form class="login-form">
          <input type="email" placeholder="email" />
          <input type="password" placeholder="password" />
          <button id="vcp" style="margin-bottom: 10px;">Verify Captcha</button>
          <button>login</button>
        </form>
      </div>
    </div>
    <div id="Captcha"></div>

    <!-- Client side code  -->
    <script>
      //        $("#voice").click(e => {
      //          alert("yo")
      //         var utterance = new SpeechSynthesisUtterance('Hello, Ma Mukesh bol rahe hu...kase ho tum abhay')
      // utterance.pitch = 0.1
      // utterance.volume = 1
      // utterance.rate = 1
      // utterance.lang='hi-IN'
      // speechSynthesis.speak(utterance)

      //     })

      $(document).ready(() => {
        $("#vcp").click(e => {
          e.preventDefault();

          function getScrollBarWidth() {
            var $outer = $("<div>")
                .css({
                  visibility: "hidden",
                  width: 100,
                  overflow: "scroll"
                })
                .appendTo("body"),
              widthWithScroll = $("<div>")
                .css({ width: "100%" })
                .appendTo($outer)
                .outerWidth();
            $outer.remove();
            return 100 - widthWithScroll;
          }

          let imgData;
          let payload = {
            w: document.body.clientWidth - getScrollBarWidth(),
            h: document.body.clientHeight
          };

          console.log(payload);
          $.post("/api/cct", payload).then(msg => {
           // console.log(msg);
            let myp5 = new p5(sketch => {
              var socket = io(
                window.location.href
                  .split("/")
                  .slice(0, 3)
                  .join("/")
              );

              //socket's world begin here!!
              socket.on("connect", () => {
                localStorage.setItem("Cuid", socket.id);
              });
              socket.on("vib", () => {
                console.log("Vibrate");
                navigator.vibrate(90);
              });

              socket.on("valid", () => {
                $("#vcp").text("CAPTCHA PassðŸ˜ƒ");
                $("#defaultCanvas0").remove();
              });

              socket.on("fail", () => {
                $("#vcp").text("CAPTCHA FailðŸ˜“");
                $("#defaultCanvas0").remove();
              });
              if(msg.isMobile){
              var x = 1,
                y = 1,
                z;
              var xpos = msg.ball[0],
                ypos = msg.ball[1];
              var speed = 2;
              var img;

              sketch.setup = () => {
                // spkBtn = sketch.createButton('ðŸ—£');
                // spkBtn.sketch.position(0, 0);
                var raw = new Image();
                raw.src = msg.bg;
                let s = sketch.createCanvas(
                  document.body.clientWidth - getScrollBarWidth(),
                  document.body.clientHeight
                );
                sketch.background("#f1c6d3");

                s.parent("Captcha");
                raw.onload = function() {
                  img = sketch.createImage(
                    document.body.clientWidth,
                    document.body.clientHeight
                  );
                  img.drawingContext.drawImage(raw, 0, 0);
                  sketch.image(img, 0, 0); // draw the image, etc here
                  sketch.noLoop();
                };
              };

              let vBtn;
              let instructionFlag = 0;
              sketch.draw = () => {
                sketch.background("#eae9e9");
                sketch.image(img, 0, 0);

                // add/subract xpos and ypos
                xpos = xpos - speed * x;
                ypos = ypos + speed * y;

                // wrap ellipse if over bounds
                if (xpos > sketch.windowWidth) {
                  xpos = sketch.windowWidth;
                }
                if (xpos < 0) {
                  xpos = 0;
                }
                if (ypos > sketch.windowHeight) {
                  ypos = sketch.windowHeight;
                }
                if (ypos < 0) {
                  ypos = 0;
                }
                // sketch.text("x: "+xpos,10,30);
                // sketch.text("y: "+ypos,10,60);

                sketch.textSize(16);
                sketch.fill("#ec7373");
                sketch.noStroke();
                sketch.ellipse(xpos, ypos, msg.ball[2], msg.ball[2]);
                if (instructionFlag == 0) {
                  instructionFlag = 1;
                  sketch.fill("#000000");
                  sketch.textFont("Comic Sans MS");
                  sketch.textSize(16);
                  sketch.text(
                    "Instruction:-\nTilt your phone to move the ball into the circle",
                    10,
                    30
                  );
                  sketch.textAlign(sketch.CENTER);
                  sketch.text(
                    "Tap to Start",
                    sketch.width / 2,
                    sketch.height / 2
                  );
                  vBtn = sketch
                    .createButton("ðŸ”Š")
                    .position(sketch.width - 40, 0)
                    .addClass("example_a");
                  vBtn.mousePressed(vmsg);
                  vBtn.id("voice");
                  function vmsg() {
                    var utterance = new SpeechSynthesisUtterance(
                      "Tilt your phone to move the ball into the circle."
                    );
                    utterance.pitch = 1;
                    utterance.volume = 1;
                    utterance.rate = 1;
                    utterance.lang = "hi-IN";
                    speechSynthesis.speak(utterance);
                  }

                  sel = sketch.createSelect().addClass("top");
                  sel.position(sketch.width - 100, 0);
                  sel.option("pear");
                  sel.option("kiwi");
                  sel.option("grape");
                  console.log(sel);
                }
              };
              let devData = {
                id: "",
                xy: [],
                acc: [],
                metaData: msg.metaData
              };
              let flag = true;
              sketch.mousePressed = a => {
                console.log(a.target.id);
                if (a.target.id === "voice") {
                  return;
                }
                if (flag) {
                  flag = false;
                  sketch.loop();
                  runBro();
                }
              };

              function runBro() {
                window.x = setInterval(() => {
                  devData.id = socket.id;
                  devData.xy.push([parseInt(xpos), parseInt(ypos)]);
                  socket.emit("move", {
                    x: xpos,
                    y: ypos,
                    r: msg.ball[2],
                    metaData: msg.metaData
                  });
                }, 250);

                setTimeout(() => {
                  sketch.noLoop();
                  vBtn.remove();
                  socket.emit("save", devData);
                  console.log("Calling save");
                }, 10000);
              }

              window.addEventListener("devicemotion", function(e) {
                // get accelerometer values
                x = parseInt(e.accelerationIncludingGravity.x);
                y = parseInt(e.accelerationIncludingGravity.y);
                devData.acc.push([parseInt(x), parseInt(y)]);
              });
              }
              else{
                //NOTE Desktop
 console.log("dekstop ");

 function Random(min, max) {
  return Math.floor(Math.random() * (max - min) + min);
}

criteria = Math.floor(Random(0,4));
console.log("criteria" + criteria);

no_of_shapes = Math.floor(Random(8,12));
console.log("no. of shapes" + no_of_shapes);

var gola =[];
var squa =[];
var flag;

//Based on color
if(criteria==0)
{
  color1 = {r:Random(0,100),g:Random(0,100),b:Random(0,100)};
  color2 = {r:Random(150,256),g:Random(150,256),b:Random(150,256)};
}

//Based on thickness 
else if(criteria==1)
{
  thick1 = Random(10,15);
  thick2 = Random(0,5);
}

//based on shapes
else if(criteria==2)
{
  //circle is fixed shape 
  // 0 for traingle
  // 1 for rectangle

  //shape = Random(0,2);
}

else
{
  size1 = Random(30,50);
  size2 = Random(80,100);
}

function Circle() {
  this.x = Random(0,sketch.windowWidth);
  this.y = Random(0,sketch.windowHeight);
  this.display = function(a,b,c,s,size){
    sketch.fill(a,b,c);
    sketch.strokeWeight(s);
    sketch.circle(this.x,this.y,size);
  }
  this.move = function(){
    this.x = sketch.mouseX;
    this.y = sketch.mouseY;
    
    if(sketch.mouseX>=sketch.windowWidth)
    {
      this.x = sketch.windowWidth;
    }
    
    if(sketch.mouseX<=0)
    {
      this.x = 0;
    }
    
    if(sketch.mouseY>=sketch.windowHeight)
    {
      this.y = sketch.windowHeight;
    }
    
    if(sketch.mouseY<=0)
    {
      this.y=0;
    }
  }
}

function Square() {
  this.x = Random(0,sketch.windowWidth);
  this.y = Random(0,sketch.windowHeight);
  this.display = function(a,b,c,s){
    sketch.fill(a,b,c);
    sketch.strokeWeight(s);
    sketch.square(this.x,this.y,50);
  }
  this.move = function(){
    this.x = sketch.mouseX;
    this.y = sketch.mouseY;
    
    if(sketch.mouseX>=sketch.windowWidth)
    {
      this.x = sketch.windowWidth-50;
    }
    
    if(sketch.mouseX<=0)
    {
      this.x = 0;
    }
    
    if(sketch.mouseY>=sketch.windowHeight)
    {
      this.y = sketch.windowHeight-50;
    }
    
    if(sketch.mouseY<=0)
    {
      this.y=0;
    }
  }
}

sketch.mousePressed = () =>
{ 
  flag =0;

  if(criteria==0||criteria==1)
  {
    for(i=0;i<no_of_shapes;i++)
    {
      d  = sketch.dist(sketch.mouseX,sketch.mouseY,gola[i].x,gola[i].y);
        if(d<50)
        { 
          flag=1;
          c1 = new Circle();
          c1 = gola[i];
        }
    }
  }
  
  else if(criteria==2)
  {
    for(i=0;i<no_of_shapes/2;i++)
    {
      d  = sketch.dist(sketch.mouseX,sketch.mouseY,gola[i].x,gola[i].y);
        if(d<50)
        { 
          flag=1;
          c1 = new Circle();
          c1 = gola[i];
        }
    }
    
    for(i=Math.floor(no_of_shapes/2);i<no_of_shapes;i++)
    {
      if(sketch.mouseX <= (squa[i].x + 50) && sketch.mouseX >= squa[i].x && sketch.mouseY <= (squa[i].y + 50) && sketch.mouseY >= squa[i].y)
      {
        flag=2;
        s1 = new Square();
        s1 = squa[i];
      }
    }
  }
  
  else
  {
    for(i=0;i<no_of_shapes/2;i++)
    {
      d  = sketch.dist(sketch.mouseX,sketch.mouseY,gola[i].x,gola[i].y);
        if(d<(size1/2))
        { 
          flag=1;
          c1 = new Circle();
          c1 = gola[i];
        }
    }
    for(i=Math.floor(no_of_shapes/2);i<no_of_shapes;i++)
    {
      d  = sketch.dist(sketch.mouseX,sketch.mouseY,gola[i].x,gola[i].y);
        if(d<(size2/2))
        { 
          flag=1;
          c1 = new Circle();
          c1 = gola[i];
        }
    }
  }
}

sketch.mouseDragged=()=>
{  
  if(flag==1)
  {
    c1.move();
  }
  else if(flag==2)
  {
    s1.move();
  }
  
}
var img;
//NOTE Setup
sketch.setup= ()=> {
  console.log(msg.msg);
  img = sketch.loadImage(msg.msg);
  
  w =sketch.windowWidth;
  h =sketch.windowHeight;
  let s= sketch.createCanvas( document.body.clientWidth - getScrollBarWidth(),
                  document.body.clientHeight);
  sketch.image(img, 0, 0, sketch.width, sketch.height);
  s.parent("Captcha");
  if(criteria==0||criteria==1||criteria==3)
  {  
  for(i=0;i<no_of_shapes;i++)
  {
  gola[i] = new Circle();
  console.log(gola[i])
  }
  }
  
  else 
  {
    for(i=0;i<no_of_shapes/2;i++)
    {
      gola[i] = new Circle();
      console.log(gola[i])
    }
    for(i=Math.floor(no_of_shapes/2);i<no_of_shapes;i++)
    {
      squa[i] = new Square();
      console.log(squa[i]);
    }
  }
}

sketch.draw=()=> {
  sketch.background(220);
  sketch.image(img, 0, 0, sketch.width, sketch.height);
  
  if(criteria==0)
  {
    //console.log(no_of_shapes/2)
  for(i=0;i<Math.floor(no_of_shapes/2);i++)
  {
    //console.log(gola[i]);
    gola[i].display(color1.r,color1.g,color1.b,1,100);
  }
    
  for(i=Math.floor(no_of_shapes/2);i<no_of_shapes;i++)
  {
    //console.log(gola[i]);
    gola[i].display(color2.r,color2.g,color2.b,1,100);
  }
  }
  
  else if(criteria==1)
  {
    
    for(i=0;i<Math.floor(no_of_shapes/2);i++)
  {
    //console.log(gola[i]);
    gola[i].display(255, 102, 102,thick1,100);
  }
    
  for(i=Math.floor(no_of_shapes/2);i<no_of_shapes;i++)
  {
    //console.log(gola[i]);
    gola[i].display(255, 102, 102,2,100);
  }
  
  }
  
  else if(criteria==2)
  {  
    
    for(i=0;i<Math.floor(no_of_shapes/2);i++)
  {
    //console.log(gola[i]);
    gola[i].display(255, 102, 102,1,100);
  }
    
    for(i=Math.floor(no_of_shapes/2);i<no_of_shapes;i++)
  {
    //console.log(squa[i]);
    squa[i].display(255, 102, 102,2);
  }
    
  }
  
  else
  {
    for(i=0;i<Math.floor(no_of_shapes/2);i++)
  {
    //console.log(gola[i]);
    gola[i].display(255, 102, 102,1,size1);
  }
    
    for(i=Math.floor(no_of_shapes/2);i<no_of_shapes;i++)
  {
    //console.log(gola[i]);
    gola[i].display(255, 102, 102,1,size2);
  }
  }
  
}


              }
            });
            $("#defaultCanvas0").show();
          });
        });
      });
    </script>
  </body>
</html>
