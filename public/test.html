<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Testing Traptcha</title>

    <link rel="stylesheet" type="text/css" href="/css/style.css" />

    <!-- jquery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    <!-- p5js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.10.2/p5.js"></script>

    <!-- socket io (Part of client code)-->
    <script src="/socket.io/socket.io.js"></script>

    <!-- jQuery Modal -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.css" />

    
  </head>
  <body>
    <div class="login-page">
      <div class="form">
        <form class="login-form">
          <input type="email" placeholder="email" />
          <input type="password" placeholder="password" />
          <button id="vcp" style="margin-bottom: 10px;">Verify Captcha</button>
          <button>login</button>
        </form>
      </div>
    </div>
    <div id="Captcha"></div>


    <!-- Client side code  -->
    <script>
       $("#voice").click(e => {
         alert("yo")
        var utterance = new SpeechSynthesisUtterance('Hello, Ma Mukesh bol rahe hu...kase ho tum abhay')
utterance.pitch = 0.1
utterance.volume = 1
utterance.rate = 1
utterance.lang='hi-IN'
speechSynthesis.speak(utterance)

    })

      $(document).ready(() => {


        $("#vcp").click(e => {
          e.preventDefault();

          function getScrollBarWidth() {
            var $outer = $("<div>")
                .css({
                  visibility: "hidden",
                  width: 100,
                  overflow: "scroll"
                })
                .appendTo("body"),
              widthWithScroll = $("<div>")
                .css({ width: "100%" })
                .appendTo($outer)
                .outerWidth();
            $outer.remove();
            return 100 - widthWithScroll;
          }

          let imgData;
          let payload = {
            w: document.body.clientWidth - getScrollBarWidth(),
            h: document.body.clientHeight
          };

          console.log(payload);
          $.post("/api/cct", payload).then(msg => {
            console.log(msg);
            let myp5 = new p5(sketch => {
              var socket = io(window.location.href.split('/').slice(0, 3).join('/') );
             
              //socket's world begin here!!
              socket.on('connect',()=>{
                localStorage.setItem('Cuid',socket.id)
              })
              socket.on('vib',()=>{
                console.log("Vibrate");
                navigator.vibrate(90)
              })

              socket.on('valid',()=>{
              $("#vcp" ).text("CAPTCHA PassðŸ˜ƒ");
              $("#defaultCanvas0").remove();
              })

              socket.on('fail',()=>{
                $("#vcp" ).text("CAPTCHA FailðŸ˜“");
                $("#defaultCanvas0").remove();
              })
              var x = 1,
                y = 1,
                z;
              var xpos = msg.ball[0],
                ypos = msg.ball[1];
              var speed = 2;
              var img;



              sketch.setup = () => {

                
                // spkBtn = sketch.createButton('ðŸ—£');
                // spkBtn.sketch.position(0, 0);
                var raw = new Image();
                raw.src = msg.bg;
                let s = sketch.createCanvas(
                  document.body.clientWidth - getScrollBarWidth(),
                  document.body.clientHeight
                );
                sketch.background('#f1c6d3');
  
        
                s.parent("Captcha");
                raw.onload = function() {
                  img = sketch.createImage(
                    document.body.clientWidth,
                    document.body.clientHeight
                  );
                  img.drawingContext.drawImage(raw, 0, 0);
                  sketch.image(img, 0, 0); // draw the image, etc here

                  sketch.noLoop();
                };

      
              };

              let vBtn;              
              let instructionFlag=0;
              sketch.draw = () => {
                if (msg.isMobile) {

                  sketch.background('#eae9e9');
                  sketch.image(img, 0, 0);

                  // add/subract xpos and ypos
                  xpos = xpos - speed * x;
                  ypos = ypos + speed * y;

                  // wrap ellipse if over bounds
                  if (xpos > sketch.windowWidth) {
                    xpos = sketch.windowWidth;
                  }
                  if (xpos < 0) {
                    xpos = 0;
                  }
                  if (ypos > sketch.windowHeight) {
                    ypos = sketch.windowHeight;
                  }
                  if (ypos < 0) {
                    ypos = 0;
                  }
                  // sketch.text("x: "+xpos,10,30);
                  // sketch.text("y: "+ypos,10,60);

                  sketch.textSize(16);
                  sketch.fill('#ec7373');
                  sketch.noStroke();
                  sketch.ellipse(xpos, ypos, msg.ball[2], msg.ball[2]);
                  if(instructionFlag==0){
                  instructionFlag=1;
                  sketch.fill('#000000');
                  sketch.textFont('Comic Sans MS');
                  sketch.textSize(16);
                  sketch.text('Instruction:-\nTilt your phone to move the ball into the circle', 10, 30);
                  sketch.textAlign(sketch.CENTER);
                  sketch.text('Tap to Start', sketch.width/2, sketch.height/2);
                  vBtn = sketch.createButton("ðŸ”Š").position(sketch.width-40,0).addClass('example_a');
                  vBtn.mousePressed(vmsg);
                  vBtn.id('voice');
                  function vmsg(){
                    var utterance = new SpeechSynthesisUtterance('Tilt your phone to move the ball into the circle.')
                    utterance.pitch = 1
                    utterance.volume = 1
                    utterance.rate = 1
                    utterance.lang='hi-IN'
                    speechSynthesis.speak(utterance)
                  }


                  sel = sketch.createSelect().addClass('top');;
                  sel.position(sketch.width-100, 0);
                  sel.option('pear');
                  sel.option('kiwi');
                  sel.option('grape');
                  console.log(sel);
                  
                  }
                }
              };
              let devData={
                id:'',
                xy : [],
                acc:[],
                metaData:msg.metaData
              }
              let flag=true;
               sketch.mousePressed = (a) => {
                 console.log(a.target.id)
                if(a.target.id==='voice'){
                  return;
                }
                 if(flag){
                   flag=false;
                   sketch.loop();
                   runBro();}
              }


              function runBro(){
              window.x =setInterval( ()=>{
                devData.id= socket.id;
                devData.xy.push([parseInt(xpos),parseInt(ypos)]);
                socket.emit("move", { x: xpos, y: ypos,r:msg.ball[2],metaData:msg.metaData})
              } ,250);

              setTimeout(()=>{
                sketch.noLoop();
                vBtn.remove();
                socket.emit('save',devData);
                console.log("Calling save");
              },10000)
            }


              window.addEventListener("devicemotion", function(e) {
                // get accelerometer values
                x = parseInt(e.accelerationIncludingGravity.x);
                y = parseInt(e.accelerationIncludingGravity.y);
                devData.acc.push([ parseInt(x), parseInt(y)])
               
              });
            });
            $("#defaultCanvas0").show();
          });
        });
      });
    </script>
  </body>
</html>
